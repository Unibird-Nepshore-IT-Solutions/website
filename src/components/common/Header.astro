---
import { CircleXIcon } from "lucide-react";

import {
  getLangFromUrl,
  getLocalizedPath,
  getRouteFromUrl,
  useTranslations,
} from "@/i18n/utils";

import { Button } from "@/components/ui/button";
import Image from "astro/components/Image.astro";
import LanguageSwitcher from "@components/common/LanguageSwitcher.tsx";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const navItems = [
  { path: "", label: t("nav.home") },
  { path: "our-services", label: t("nav.services") },
  { path: "about-us", label: t("nav.about") },
  { path: "testimonials", label: t("nav.testimonials") },
  { path: "our-products", label: t("nav.our_products") },
  { path: "why-us", label: t("nav.why_us") },
  { path: "contact", label: t("nav.contact") },
];
---

<header>
  <div
    id="banner"
    class="bg-primary text-center pr-12 pl-24 py-3 text-sm flex items-center justify-between"
  >
    <div></div>
    <p class="text-primary-foreground">
      {t("need_help")}
      <span class="underline font-bold">{t("request_for_a_call")} !</span>
    </p>
    <Button className="size-6" id="close_btn" title={t("close")}>
      <CircleXIcon fill="white" strokeWidth="1" stroke="#097ac6" />
    </Button>
  </div>

  <nav
    id="navbar"
    class="w-full pr-12 pl-24 border-b border-border flex gap-2 items-center justify-between bg-background relative"
  >
    <a href="/" class="w-20 h-16 overflow-hidden">
      <Image
        alt="Logo"
        width={55}
        height={48}
        src="/assets/images/logo.png"
        class="size-full block object-contain"
      />
    </a>

    <div>
      <ul class="container flex gap-6">
        {
          navItems.map((item) => (
            <li>
              <a
                href={"#" + item.path}
                data-section={item.path}
                class={`nav-item text-foreground hover:text-primary-dark transition-colors no-underline ${lang !== "en" ? "break-keep" : "break-normal"} ${item.path === "" ? "active-nav" : ""}`}
              >
                {item.label}
              </a>
            </li>
          ))
        }
      </ul>
    </div>

    <div>
      <LanguageSwitcher
        client:only="react"
        currentLang={lang}
        route={getRouteFromUrl(Astro.url)}
      />
    </div>
  </nav>
</header>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const navbar = document.getElementById("navbar");
    const banner = document.getElementById("banner");
    const closeBtn = document.getElementById("close_btn");
    const navItems = document.querySelectorAll(".nav-item");

    if (!navbar || !banner) return;

    const bannerHeight = banner.offsetHeight;
    let ticking = false;

    function setActiveNavItem(sectionId: string) {
      navItems.forEach((item) => {
        const itemSection = item.getAttribute("data-section");
        if (itemSection === sectionId) {
          item.classList.add("active-nav");
        } else {
          item.classList.remove("active-nav");
        }
      });
    }

    const observerOptions = {
      root: null,
      threshold: 0,
      rootMargin: "-20% 0px -60% 0px",
    };

    const sectionObserver = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const sectionId = entry.target.id;
          setActiveNavItem(sectionId);
        }
      });
    }, observerOptions);

    navItems.forEach((item) => {
      const sectionId = item.getAttribute("data-section");
      if (sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
          sectionObserver.observe(section);
        }
      }
    });

    navItems.forEach((item) => {
      item.addEventListener("click", function (this: HTMLElement) {
        const sectionId = this.getAttribute("data-section");
        setActiveNavItem(sectionId || "");
      });
    });

    function checkInitialHash() {
      const hash = window.location.hash.substring(1);
      setActiveNavItem(hash || "");
    }

    window.addEventListener("hashchange", checkInitialHash);
    checkInitialHash();

    function updateNavbar() {
      if (!navbar) return;
      const scrollTop =
        window.pageYOffset || document.documentElement.scrollTop;

      if (scrollTop > bannerHeight) {
        if (!navbar.classList.contains("fixed-nav")) {
          navbar.classList.add("fixed-nav");
          navbar.style.top = "0";
          navbar.style.left = "0";
          navbar.style.right = "0";
          navbar.style.zIndex = "50";
          navbar.style.backdropFilter = "blur(4px)";
          navbar.style.backgroundColor = "rgba(255, 255, 255, 0.85)";
        }
      } else {
        if (navbar.classList.contains("fixed-nav")) {
          navbar.classList.remove("fixed-nav");
          navbar.style.cssText = "";
        }
      }
    }

    updateNavbar();

    window.addEventListener(
      "scroll",
      () => {
        if (!ticking) {
          window.requestAnimationFrame(() => {
            updateNavbar();
            ticking = false;
          });
          ticking = true;
        }
      },
      { passive: true }
    );

    if (closeBtn) {
      closeBtn.addEventListener("click", () => {
        banner?.classList.add("hidden");
      });
    }
  });
</script>

<style>
  .fixed-nav {
    position: fixed !important;
    animation: slideDown 0.3s ease-out;
  }

  .active-nav {
    font-weight: 600;
    position: relative;
    color: var(--primary-dark) !important;
  }

  .active-nav::after {
    content: "";
    position: absolute;
    bottom: -23px;
    left: 0;
    width: 100%;
    height: 3px;
    border-radius: 1px;
    background-color: var(--primary-dark);
  }

  @keyframes slideDown {
    from {
      transform: translateY(-100%);
    }
    to {
      transform: translateY(0);
    }
  }

  body.has-fixed-nav {
    padding-top: var(--nav-height, 80px);
  }
</style>
