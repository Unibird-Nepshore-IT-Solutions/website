---
import { CircleXIcon } from "lucide-react";

import {
  getLangFromUrl,
  getLocalizedPath,
  getRouteFromUrl,
  useTranslations,
} from "@/i18n/utils";

import { Button } from "@/components/ui/button";
import Image from "astro/components/Image.astro";
import LanguageSwitcher from "@components/common/LanguageSwitcher.tsx";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const navItems = [
  { path: "", label: t("nav.home") },
  { path: "services", label: t("nav.services") },
  { path: "about", label: t("nav.about") },
  { path: "testimonials", label: t("nav.testimonials") },
  { path: "our-products", label: t("nav.our_products") },
  { path: "why-us", label: t("nav.why_us") },
  { path: "contact", label: t("nav.contact") },
];
---

<header>
  <div
    id="banner"
    class="bg-primary text-center pr-12 pl-24 py-3 text-sm flex items-center justify-between"
  >
    <div></div>
    <p class="text-primary-foreground">
      {t("need_help")}
      <span class="underline font-bold">{t("request_for_a_call")} !</span>
    </p>
    <Button className="size-6" id="close_btn" title={t("close")}>
      <CircleXIcon fill="white" strokeWidth="1" stroke="#097ac6" />
    </Button>
  </div>

  <nav
    id="navbar"
    class="w-full pr-12 pl-24 border-b border-border flex gap-2 items-center justify-between bg-background relative"
  >
    <div class="w-20 h-16 overflow-hidden">
      <Image
        alt="Logo"
        width={55}
        height={48}
        src="/assets/images/logo.png"
        class="size-full block object-contain"
      />
    </div>

    <div>
      <ul class="container flex gap-6">
        {
          navItems.map((item) => (
            <li>
              <a
                href={getLocalizedPath(item.path, lang)}
                class={`text-foreground hover:text-primary-dark transition-colors no-underline ${lang !== "en" ? "break-keep" : "break-normal"}`}
              >
                {item.label}
              </a>
            </li>
          ))
        }
      </ul>
    </div>

    <div>
      <LanguageSwitcher
        client:only="react"
        currentLang={lang}
        route={getRouteFromUrl(Astro.url)}
      />
    </div>
  </nav>
</header>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const navbar = document.getElementById("navbar");
    const banner = document.getElementById("banner");
    const closeBtn = document.getElementById("close_btn");

    if (!navbar || !banner) return;

    const bannerHeight = banner.offsetHeight;

    function updateNavbar() {
      if (!navbar || !banner) return;
      const scrollTop =
        window.pageYOffset || document.documentElement.scrollTop;

      if (scrollTop > bannerHeight) {
        navbar.classList.add("fixed-nav");
        navbar.style.top = "0";
        navbar.style.left = "0";
        navbar.style.right = "0";
        navbar.style.zIndex = "50";
        navbar.style.backdropFilter = "blur(4px)";
        navbar.style.backgroundColor = "rgba(255, 255, 255, 0.85)";
      } else {
        navbar.classList.remove("fixed-nav");
        navbar.style.cssText = "";
      }
    }

    updateNavbar();

    let ticking = false;
    window.addEventListener("scroll", () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          updateNavbar();
          ticking = false;
        });
        ticking = true;
      }
    });

    window.addEventListener("resize", () => updateNavbar());

    function closeBanner() {
      if (!closeBtn) return;
      banner?.classList.add("hidden");
    }

    window.addEventListener("click", () => closeBanner());
  });
</script>

<style>
  .fixed-nav {
    position: fixed !important;
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      transform: translateY(-100%);
    }
    to {
      transform: translateY(0);
    }
  }

  body.has-fixed-nav {
    padding-top: var(--nav-height, 80px);
  }
</style>
