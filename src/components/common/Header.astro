---
import { CircleXIcon } from "lucide-react";

import { getLangFromUrl, getRouteFromUrl, useTranslations } from "@/i18n/utils";

import "@styles/Header.css";
import { MobileNav } from "./MobileNav.tsx";
import { Button } from "@/components/ui/button";
import Image from "astro/components/Image.astro";
import LanguageSwitcher from "@components/common/LanguageSwitcher.tsx";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const navItems = [
  { path: "home", label: t("nav.home") },
  { path: "our-services", label: t("nav.services") },
  { path: "about-us", label: t("nav.about") },
  { path: "testimonials", label: t("nav.testimonials") },
  { path: "our-products", label: t("nav.our_products") },
  { path: "why-us", label: t("nav.why_us") },
  { path: "contact", label: t("nav.contact") },
];
---

<header class="@container">
  <div
    id="banner"
    class="bg-primary text-center pr-12 pl-24 py-3 text-sm flex items-center justify-between"
  >
    <div></div>
    <p class="text-primary-foreground">
      {t("need_help")}
      <span class="underline font-bold">{t("request_for_a_call")} !</span>
    </p>
    <Button className="size-6" id="close_btn" title={t("close")}>
      <CircleXIcon fill="white" strokeWidth="1" stroke="#097ac6" />
    </Button>
  </div>

  <nav
    id="navbar"
    role="navigation"
    aria-label="Main navigation"
    class="w-full pr-12 pl-24 border-b border-border flex gap-2 items-center justify-between bg-background relative"
  >
    <a href="/" class="w-20 h-16 overflow-hidden">
      <Image
        alt="Logo"
        width={55}
        height={48}
        src="/assets/images/logo.png"
        class="size-full block object-contain"
      />
    </a>

    <!-- Horizontal Navigation for Laptop+ screens -->
    <div class="hidden @4xl:block">
      <ul class="container hidden @4xl:flex gap-3 @5xl:gap-6">
        {
          navItems.map((item) => (
            <li>
              <a
                href={"#" + item.path}
                data-section={item.path}
                class={`text-sm @7xl:text-base nav-item text-foreground hover:text-primary-dark transition-colors no-underline ${lang !== "en" ? "break-keep" : "break-normal"} ${item.path === "" ? "active-nav" : ""}`}
              >
                {item.label}
              </a>
            </li>
          ))
        }
      </ul>
    </div>

    <div class="hidden @4xl:block">
      <LanguageSwitcher
        client:load
        currentLang={lang}
        route={getRouteFromUrl(Astro.url)}
      />
    </div>

    <!-- Hamburger Menu for smaller screen sizes -->
    <div class="block @4xl:hidden relative">
      <MobileNav url={Astro.url} lang={lang} navItems={navItems} client:load />
    </div>
  </nav>
</header>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const navbar = document.getElementById("navbar");
    const banner = document.getElementById("banner");
    const closeBtn = document.getElementById("close_btn");
    const navItems = document.querySelectorAll(".nav-item");

    if (!navbar || !banner) return;

    const bannerHeight = banner.offsetHeight;
    let ticking = false;

    function setActiveNavItem(sectionId: string) {
      navItems.forEach((item) => {
        const itemSection = item.getAttribute("data-section");
        if (itemSection === sectionId) {
          item.classList.add("active-nav");
        } else {
          item.classList.remove("active-nav");
        }
      });

      window.dispatchEvent(
        new CustomEvent("sectionchange", { detail: { sectionId } })
      );
    }

    const observerOptions = {
      root: null,
      threshold: 0.15,
      rootMargin: "-80px 0px -80px 0px",
    };

    const sectionObserver = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const sectionId = entry.target.id;
          setActiveNavItem(sectionId);
        }
      });
    }, observerOptions);

    navItems.forEach((item) => {
      const sectionId = item.getAttribute("data-section");
      if (sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
          sectionObserver.observe(section);
        }
      }
    });

    navItems.forEach((item) => {
      item.addEventListener("click", function (this: HTMLElement) {
        const sectionId = this.getAttribute("data-section");
        setActiveNavItem(sectionId || "home");
      });
    });

    function checkInitialHash() {
      const hash = window.location.hash.substring(1);
      setActiveNavItem(hash || "home");
    }

    window.addEventListener("hashchange", checkInitialHash);
    checkInitialHash();

    function updateNavbar() {
      if (!navbar) return;
      const scrollTop =
        window.pageYOffset || document.documentElement.scrollTop;

      if (scrollTop > bannerHeight) {
        if (!navbar.classList.contains("fixed-nav")) {
          navbar.classList.add("fixed-nav");
          navbar.style.top = "0";
          navbar.style.left = "0";
          navbar.style.right = "0";
          navbar.style.zIndex = "50";
          navbar.style.backdropFilter = "blur(4px)";
          navbar.style.backgroundColor = "rgba(255, 255, 255, 0.85)";
        }
      } else {
        if (navbar.classList.contains("fixed-nav")) {
          navbar.classList.remove("fixed-nav");
          navbar.style.cssText = "";
        }
      }
    }

    updateNavbar();

    window.addEventListener(
      "scroll",
      () => {
        if (!ticking) {
          window.requestAnimationFrame(() => {
            updateNavbar();
            ticking = false;
          });
          ticking = true;
        }
      },
      { passive: true }
    );

    if (closeBtn) {
      closeBtn.addEventListener("click", () => {
        banner?.classList.add("hidden");
      });
    }
  });
</script>
